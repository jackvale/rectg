#!/usr/bin/env python3
"""
æ–‡æœ¬æ¸…æ´—ä¸ç²¾ç»†åŒ–åˆ†ç±»è„šæœ¬ (categorize.py)
ç”¨äºæ¸…ç†æ ‡é¢˜å’Œæè¿°ä¸­çš„ Emojiã€å†—ä½™æ–‡æœ¬ï¼Œå¹¶åŸºäºå…³é”®å­—è¿›è¡Œè‡ªåŠ¨ç»†åˆ†åˆ†ç±»ã€‚

ç”¨æ³•:
    python3 scripts/categorize.py
"""

import sqlite3
import re
from pathlib import Path
import emoji

DB_PATH = Path(__file__).resolve().parent.parent / "data" / "rectg.db"

# ---------------------------------------------------------------------------
# 0. æœ‰å®³å†…å®¹åŠè¯­è¨€è¿‡æ»¤
# ---------------------------------------------------------------------------

HARMFUL_KEYWORDS = [
    "åšå½©", "èµŒåœº", "èµ„é‡‘ç›˜", "è·‘åˆ†", "æªæ”¯", "è¿·è¯", "å‚¬æƒ…", "è¿·å¹»",
    "æ´—é’±", "æç°", "æŸ¥æ¡£", "å¼€æˆ¿è®°å½•", "ç¤¾å·¥åº“", "å‘¼æ­»ä½ ", "è½°ç‚¸æœº",
    "è èœ", "å«©æ¨¡", "å¤–å›´", "çº¦ç‚®", "è¿·å¥¸", "ä»£å¼€å‘ç¥¨", "é»‘äº§", "ç½‘èµš",
    "è‰²æµ", "å½©ç¥¨", "èµŒåš", "ç™¾å®¶ä¹", "å…­åˆå½©", "æ£‹ç‰Œ", "ç½‘èµŒ", "é»‘å®¢", "ç ´è§£ç›—åˆ·",
    "å…è´¹èŠ‚ç‚¹", "ç¿»å¢™", "æœºåœº", "å…æµ", "æ¢¯å­", "ç§‘å­¦ä¸Šç½‘", "v2ray", "shadowsocks",
    "èå¼", "å…¨å¥—", "å“èŒ¶", "ä¿®è½¦", "åŒåŸç¾¤", "çº¦å¦¹"
]

# ç”¨äºåŒ¹é…â€œç¦æ­¢XXXâ€çš„æ­£åˆ™ï¼Œè¿™äº›è¯è¯­å¦‚æœå‡ºç°åœ¨â€œç¦æ­¢â€ã€â€œä¸¥ç¦â€ä¹‹åï¼Œåˆ™å±äºæ­£å¸¸çš„ç¾¤è§„ï¼Œä¸åº”è¯¥è¢«åˆ¤å®šä¸ºæœ‰å®³é¢‘é“
PROHIBITED_CONTEXT_REGEX = re.compile(r'(ç¦æ­¢|ä¸¥ç¦|ä¸å‡†|æ‹’ç»|è°¢ç»).*?(æœºåœº|ç¿»å¢™|æ¢¯å­|èŠ‚ç‚¹|å…æµ|é»‘äº§|å¹¿å‘Š|åšå½©|èµŒåš|è‰²æƒ…|æ”¿æ²»)')

def _remove_prohibited_context(text: str) -> str:
    """å¦‚æœæ–‡æœ¬ä¸­å‡ºç° 'ç¦æ­¢æœºåœº' ç­‰ç¾¤è§„å£°æ˜ï¼Œå°†å…¶ä»ç‰¹å¾æœ¬ä¸­å‰”é™¤ï¼Œé¿å…è¯¯æ€ã€‚"""
    # ç®€å•åœ°æŠŠåŒ¹é…åˆ°çš„â€œç¦æ­¢XXXâ€çŸ­è¯­æ›¿æ¢æ‰ï¼Œè¿™æ ·å®ƒä»¬å°±ä¸ä¼šè§¦å‘ subsequent çš„å…³é”®è¯åŒ¹é…
    return PROHIBITED_CONTEXT_REGEX.sub('', text)

def is_harmful(text: str) -> bool:
    text = text.lower()
    # å…ˆå‰”é™¤æ‰æ­£å¸¸ç¾¤è§„å£°æ˜ä¸­çš„æ•æ„Ÿè¯
    text_to_check = _remove_prohibited_context(text)
    
    for kw in HARMFUL_KEYWORDS:
        if kw in text_to_check:
            return True
    return False

def is_non_simplified_chinese(text: str) -> bool:
    """è¿‡æ»¤éç®€ä½“ä¸­æ–‡å†…å®¹ï¼šå¦‚æœä¸­æ–‡å­—ç¬¦æ¯”ä¾‹æä½ï¼Œè§†ä¸ºéç›®æ ‡è¯­è¨€é¢‘é“ã€‚"""
    if not text:
        return True
    
    cjk_count = len(re.findall(r'[\u4e00-\u9fff]', text))
    clean_len = len(re.sub(r'[^\w]', '', text))
    
    if clean_len > 0:
        ratio = cjk_count / clean_len
        # å¦‚æœä¸­æ–‡å­—ç¬¦å æ¯”ä½äº 15% ä¸”æ€»æœ‰æ•ˆå­—ç¬¦å¤§äº 20ï¼Œåˆ¤ä¸ºéä¸­æ–‡
        if ratio < 0.15 and clean_len > 20: 
            return True
        # å¦‚æœæ€»é•¿å¤§äº10ä½†ä¸­æ–‡å­—ç¬¦ä¸åˆ°3ä¸ª
        if cjk_count < 3 and clean_len > 10:
            return True
            
    return False

# ---------------------------------------------------------------------------
# 1. æ–‡æœ¬æ¸…æ´ (Text Optimization)
# ---------------------------------------------------------------------------

def remove_emoji(text: str) -> str:
    """å»é™¤æ–‡æœ¬ä¸­çš„æ‰€æœ‰ Emojiã€‚"""
    if not text:
        return ""
    return emoji.replace_emoji(text, replace="")

def clean_text_advanced(text: str, title: str = "") -> str:
    """é«˜çº§æ–‡æœ¬æ¸…æ´—ï¼šå»é™¤ç‰¹å®šçš„å¼•æµè¯ã€ç½‘å€ã€å¤šä½™æ¢è¡Œå’Œç¬¦å·ç­‰ï¼Œå¹¶ç»“åˆåç§°æç‚¼ã€‚"""
    if not text:
        return ""
    
    # å»é™¤ Emoji
    text = remove_emoji(text)
    
    # å»é™¤ URL é“¾æ¥å’Œ @username
    text = re.sub(r'https?://[^\s]+', '', text)
    text = re.sub(r't\.me/[^\s]+', '', text)
    text = re.sub(r'@\w+', '', text)
    text = re.sub(r'tg://[^\s]+', '', text)
    
    # å»é™¤å†—ä½™çš„å¼•æµã€å¹¿å‘Šç”¨è¯­ã€å¸¸è§æ— æ„ä¹‰çŸ­è¯­
    spam_patterns = [
        r'ç‚¹å‡»é“¾æ¥', r'åŠ å…¥ç¾¤ç»„', r'å…³æ³¨æˆ‘ä»¬', r'ç‚¹æ­¤åŠ å…¥',
        r'æ¬¢è¿æ¥åˆ°', r'å„ä½å¤§ä½¬', r'åœ¨è¿™é‡Œæ‚¨å¯ä»¥', r'ç‚¹å‡»å…³æ³¨',
        r'æœ¬ç¾¤è§„', r'è¿›ç¾¤è¯·', r'é˜²å¤±è”', r'è§£å°è¯´æ˜',
        r'å•†åŠ¡åˆä½œ', r'å¹¿å‘ŠæŠ•æ”¾', r'è”ç³»ç¾¤ä¸»', r'è”ç³»ç®¡ç†',
        r'å”¯ä¸€æŠ•ç¨¿', r'æŠ•ç¨¿è¯·è”ç³»', r'æ‰¾èµ„æºçš„', r'äº¤æµç¾¤',
        r'èŠå¤©ç¾¤', r'å¤‡ç”¨é¢‘é“', r'å®˜æ–¹é¢‘é“', r'æœ€æ–°åœ°å€',
        r'è¯·çœ‹ç½®é¡¶', r'è¿›ç¾¤çœ‹', r'è·å–æœ€æ–°', r'åˆä½œï¼š',
        r'è”ç³»ï¼š', r'å®¢æœï¼š', r'TGé¢‘é“ï¼š', r'ç”µæŠ¥é¢‘é“',
        r'ã€.*?ã€‘', r'\[.*?\]' # å»é™¤å„ç§æ‹¬å·åŒ…å›´çš„ï¼ˆå¾€å¾€æ˜¯æ ‡ç­¾ï¼‰å¦‚æœå¤ªç©ºæ´ï¼Œä½†è¿™é‡Œä¿ç•™ï¼Œå› ä¸ºå¯èƒ½æœ‰æœ‰ç”¨ä¿¡æ¯ã€‚æš‚æ—¶ä¸åˆ æ‹¬å·ã€‚
    ]
    
    for pattern in spam_patterns:
        text = re.sub(pattern, '', text, flags=re.IGNORECASE)
        
    # å»æ‰ç‰¹å®šçš„æ ¼å¼è¯è¯­å—
    text = re.sub(r'\[.*?æ¨å¹¿.*?\]|ã€.*?å¹¿å‘Š.*?ã€‘', '', text)
    text = re.sub(r'å•†åŠ¡åˆä½œ.*?\n?', '', text)
    
    # å°†é•¿ä¸²è¿ç»­çš„æ ‡ç‚¹ç¬¦å·æˆªæ–­ä¸ºå•æ ‡ç‚¹
    text = re.sub(r'([ã€‚ï¼ï¼Ÿâ€¦])\1+', r'\1', text)
    text = re.sub(r'([ï¼Œã€ï¼šï¼›])\1+', r'\1', text)
    
    # æ›¿æ¢è¿ç»­çš„æ¢è¡Œç¬¦å’Œç©ºæ ¼ä¸ºä¸€ä¸ªç©ºæ ¼
    text = re.sub(r'[\r\n\t]+', ' ', text)
    text = re.sub(r'\s{2,}', ' ', text)
    
    # å»é™¤ä¸¤ç«¯æˆ–å¤šä½™çš„æ ‡ç‚¹
    text = re.sub(r'^[ã€ï¼Œã€‚ï¼ï¼Ÿï¼šï¼›\-|~= \*\#]+|[ã€ï¼Œã€‚ï¼ï¼Ÿï¼šï¼›\-|~= \*\#]+$', '', text.strip())
    
    # æˆªæ–­ç­–ç•¥ï¼šå¦‚æœè¿˜æ˜¯å¤ªé•¿ï¼Œåˆ™æˆªå– 100 å­—ï¼Œå¯»æ‰¾æ ‡ç‚¹ç¬¦å·æ–­å¥
    if len(text) > 100:
        trunc = text[:95]
        # å°è¯•åœ¨æœ€åä¸€ä¸ªå¥å·/å¹å·/é€—å·å¤„æˆªæ–­
        match = re.search(r'[ã€‚ï¼ï¼Ÿï¼Œï¼›][^ã€‚ï¼ï¼Ÿï¼Œï¼›]*$', trunc)
        if match and match.start() > 50: # å¦‚æœååŠæ®µæœ‰æ ‡ç‚¹ç¬¦å·
            text = trunc[:match.start()+1] + "..."
        else:
            text = trunc + "..."
            
    # å¦‚æœæ¸…æ´—å®Œåªå‰©ä¸‹æå°‘çš„å­—ï¼Œä¸”ä¸ title å‡ ä¹ä¸€æ ·ï¼Œåˆ™åŠ ä¸Šâ€œç›¸å…³è®¨è®ºä¸åˆ†äº«â€
    if title and len(text) < 5 and text in title:
        text = f"å…³äº {title} çš„ç›¸å…³è®¨è®ºä¸åˆ†äº«é¢‘é“ã€‚"
        
    return text.strip()

def clean_title_advanced(title: str) -> str:
    """ä¸“é—¨ä¸º title æ¸…é™¤å¤šä½™ä¿®é¥°ç¬¦ã€‚"""
    if not title:
        return ""
    title = remove_emoji(title)
    # å¸¸ç”¨æ¥è£…é¥°åå­—çš„ç‰¹æ®Šç¬¦å·
    title = re.sub(r'[ã€ã€‘\[\]ã€Šã€‹<>|ï½œï½~*âœ¨ğŸŒŸğŸ”¥ğŸ’¥âš¡ï¸ğŸ’¯ğŸ¯ğŸğŸ‰ğŸŠ]+', ' ', title)
    title = re.sub(r'\s+', ' ', title)
    return title.strip()


# ---------------------------------------------------------------------------
# 2. ç²¾ç»†åŒ–åˆ†ç±» (Categorization) - 17 å¤§ç±» + ä¸Šä¸‹æ–‡æ„ŸçŸ¥
# ---------------------------------------------------------------------------

# ç”¨äºå‰”é™¤ç¾¤è§„/å£°æ˜ä¸­çš„å…³é”®è¯ï¼Œé¿å…"ç¦æ­¢NSFW"è¢«å½’å…¥ ğŸ”
_RULE_CONTEXT_RE = re.compile(
    r'(ç¦æ­¢|ä¸¥ç¦|ä¸å‡†|ä¸å…è®¸|æ‹’ç»|è°¢ç»|ä¸å‘|ä¸å¼€|è¯·å‹¿|è«å•†|è«å¼€|é™åˆ¶)'
    r'[^ï¼Œã€‚ï¼ï¼Ÿï¼›\n]{0,15}?'
    r'(nsfw|è‰²æƒ…|è‰²å›¾|æ¶©å›¾|18\+|å¼€è½¦|r18|adult|porn|sex|ç¦åˆ©|æ”¿æ²»|é»„èµŒæ¯’|å¹¿å‘Š|ç›—ç‰ˆ|é»‘äº§)',
    re.IGNORECASE
)

def _remove_rule_context(text: str) -> str:
    """å‰”é™¤ç¾¤è§„å£°æ˜ä¸­çš„æ•æ„Ÿè¯ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢åˆ†ç±»è¯¯åˆ¤ã€‚"""
    return _RULE_CONTEXT_RE.sub('', text)


# åˆ†ç±»åˆ—è¡¨ï¼ˆé¡ºåºå³ä¼˜å…ˆçº§ï¼Œè¶Šé å‰è¶Šä¼˜å…ˆåŒ¹é…ï¼‰
# ğŸ” æ”¾åœ¨æœ€åé¢ä»¥é™ä½è¯¯åˆ†ç±»å¯èƒ½
CATEGORIES = [
    {
        "name": "ğŸ“° æ–°é—»å¿«è®¯",
        "keywords": [
            "æ–°é—»", "å¿«è®¯", "æŠ¥çº¸", "æ—¥æŠ¥", "æ—©æŠ¥", "å‘¨åˆŠ", "æ—¶æŠ¥",
            "åª’ä½“", "æŠ¥é“", "çˆ†æ–™", "æ—¶æ”¿", "å†…å¹•", "æ—¶äº‹", "ç¯çƒ",
            "ç«¯ä¼ åª’", "rss", "æ•°å­—æ—¶ä»£", "å—æ–¹å‘¨æœ«", "çº½çº¦æ—¶æŠ¥",
            "è´¢ç»", "è´¢æ–°", "åå°”è¡—", "é‡‘èæ—¶æŠ¥",
            "åƒç“œæ’­æŠ¥", "ä¸€æ‰‹èµ„è®¯", "çƒ­ç‚¹è¿½è¸ª", "å›½é™…æ–°é—»"
        ]
    },
    {
        "name": "ğŸª™ åŠ å¯†è´§å¸",
        "keywords": [
            "åŠ å¯†è´§å¸", "å¸åœˆ", "åŒºå—é“¾", "btc", "eth", "web3",
            "ç©ºæŠ•", "æŒ–çŸ¿", "ç‚’å¸", "nft", "äº¤æ˜“æ‰€", "ä»£å¸",
            "æ•°å­—è´§å¸", "usdt", "æ¯”ç‰¹å¸", "ä»¥å¤ªåŠ", "åˆçº¦",
            "defi", "æœŸè´§", "æœŸæƒ", "æŠ•èµ„å¿«è®¯",
            "è–…ç¾Šæ¯›", "å¸åœˆå‘è´¢", "æé’±", "æŠ•èµ„äº¤æµ", "é‡åŒ–äº¤æ˜“"
        ]
    },
    {
        "name": "ğŸ¬ å½±è§†å‰§é›†",
        "keywords": [
            "ç”µå½±", "å½±è§†", "å½±é™¢", "ç”µè§†å‰§", "å‰§é›†", "ç½‘é£",
            "netflix", "4k", "ç¾å‰§", "éŸ©å‰§", "æ—¥å‰§", "ä¸­æ–‡å­—å¹•",
            "1080p", "çºªå½•ç‰‡", "bbc", "nhk", "asmr", "è§†é¢‘é¢‘é“",
            "æµåª’ä½“", "emby", "youtube", "æ‰¾å½±è§†åœ¨çº¿çœ‹", "å…è´¹è¿½å‰§", "çŸ­å‰§å¤§å…¨"
        ]
    },
    {
        "name": "ğŸµ éŸ³ä¹éŸ³é¢‘",
        "keywords": [
            "éŸ³ä¹", "æ— æŸ", "flac", "mp3", "éŸ³é¢‘", "ç½‘æ˜“äº‘",
            "qqéŸ³ä¹", "æ­Œå•", "å‘çƒ§å‹", "éŸ³å“", "æ’­å®¢", "podcast",
            "å¬ä¼—",
        ]
    },
    {
        "name": "ğŸ åŠ¨æ¼«æ¬¡å…ƒ",
        "keywords": [
            "åŠ¨æ¼«", "ç•ªå‰§", "äºŒæ¬¡å…ƒ", "acg", "è¿½ç•ª", "æ¼«ç”»",
            "è½»å°è¯´", "é‡Œç•ª", "åŒäºº", "ç”»å¸ˆ", "cosplay", "æ¼«å±•",
            "pixiv", "pç«™", "galgame", "é»„æ²¹", "èŒå›¾", "èŒåŸŸ",
            "å—¶å’”", "æ’ç”»", "åŠ¨ç”»", "é…·æ¼«",
        ]
    },
    {
        "name": "ğŸ® æ¸¸æˆå¨±ä¹",
        "keywords": [
            "æ¸¸æˆ", "æ‰‹æ¸¸", "ç«¯æ¸¸", "ä¸»æœº", "steam", "switch",
            "ps5", "xbox", "åŸç¥", "ç‹è€…è£è€€", "åƒé¸¡", "å’Œå¹³ç²¾è‹±",
            "ç”µç«", "ä¸»æœºæ¸¸æˆ", "å•æœºæ¸¸æˆ", "å¤–æŒ‚", "ç ´è§£æ¸¸æˆ",
            "å¼€é»‘", "ç¥é­”ä¹‹å¡”", "minecraft", "ç‹¼äººæ€",
        ]
    },
    {
        "name": "ğŸ’» æ•°ç ç§‘æŠ€",
        "keywords": [
            "ç§‘æŠ€", "æ•°ç ", "ç¡¬ä»¶", "apple", "è‹¹æœ", "å®‰å“",
            "ios", "mac", "windows", "æ‰‹æœº", "æµ‹è¯„", "æå®¢",
            "geek", "ç§‘æŠ€æ–°é—»", "è½¯è·¯ç”±", "è·¯ç”±å™¨", "nas",
            "ç¾¤æ™–", "openwrt", "google voice", "ä¸‰æ˜Ÿ", "å°ç±³",
            "é”®ç›˜", "apple tv", "æ ‘è“æ´¾", "raspberry",
            "ai", "chatgpt", "deepseek", "gpt", "äººå·¥æ™ºèƒ½",
            "claude", "openai", "aigc", "chromebook",
            "blackberry",
        ]
    },
    {
        "name": "ğŸ‘¨â€ğŸ’» å¼€å‘è¿ç»´",
        "keywords": [
            "å¼€æº", "ä»£ç ", "github", "å¼€å‘", "ç¨‹åºå‘˜", "å‰ç«¯",
            "åç«¯", "python", "linux", "java", "php", "golang",
            "è¿ç»´", "ç å†œ", "ç¼–ç¨‹", "æœåŠ¡å™¨", "vps", "docker",
            "ubuntu", "manjaro", "arch", "debian", "centos",
            "javascript", "typescript", "rust", "scala", "ruby",
            "cè¯­è¨€", "hadoop", "spark", "magisk", "kernelsu",
            "v2fly", "hacker news", "leetcode", "åˆ·é¢˜",
            "haskell", "perl", "css", "swiftui", "fedora",
            "vim", "openwrtå›ºä»¶",
        ]
    },
    {
        "name": "ğŸ”’ ä¿¡æ¯å®‰å…¨",
        "keywords": [
            "ä¿¡æ¯å®‰å…¨", "å®‰å…¨æŠ€æœ¯", "å®‰é˜²", "éšç§", "privacy",
            "å®‰å…¨èµ„æº", "æ¸—é€", "é˜²æŠ¤", "åŠ å¯†", "å¯†ç å­¦",
            "adguard", "é˜²æ’¤å›", "anti revoke", "ddos",
        ]
    },
    {
        "name": "âœˆï¸ ç§‘å­¦ä¸Šç½‘",
        "keywords": [
            "å…æµ", "èŠ‚ç‚¹", "ä»£ç†", "vpn", "æœºåœº", "ç§‘å­¦ä¸Šç½‘",
            "ç¿»å¢™", "v2ray", "clash", "shadowsocks", "trojan",
            "æµ‹é€Ÿ", "æ¢¯å­", "surge", "quantumult", "loon",
            "è¿·é›¾é€š", "æ¬ç“¦å·¥",
        ]
    },
    {
        "name": "â˜ï¸ ç½‘ç›˜èµ„æº",
        "keywords": [
            "ç½‘ç›˜", "é˜¿é‡Œäº‘ç›˜", "å¤¸å…‹", "ç™¾åº¦äº‘", "ç™¾åº¦ç½‘ç›˜",
            "å¤©ç¿¼", "è¿…é›·", "115", "èµ„æºåˆ†äº«", "æ‰©å®¹",
            "pt", "tracker", "ç§å­", "ç£åŠ›", "ç¦»çº¿ä¸‹è½½",
            "google drive",
        ]
    },
    {
        "name": "ğŸ§° è½¯ä»¶å·¥å…·",
        "keywords": [
            "è½¯ä»¶", "app", "ç ´è§£ç‰ˆ", "ä¿®æ”¹ç‰ˆ", "ç»¿è‰²ç‰ˆ",
            "å®‰è£…åŒ…", "apk", "macè½¯ä»¶", "winè½¯ä»¶", "æ•ˆç‡",
            "å·¥å…·", "ç¥å™¨", "å¿«æ·æŒ‡ä»¤", "è„šæœ¬",
            "ç¿»è¯‘", "translate", "simpread", "ç®€æ‚¦",
            "notion", "è¾“å…¥æ³•",
        ]
    },
    {
        "name": "ğŸ“š å­¦ä¹ é˜…è¯»",
        "keywords": [
            "å­¦ä¹ ", "å¤–è¯­", "è‹±è¯­", "æ—¥è¯­", "ç”µå­ä¹¦", "kindle",
            "epub", "pdf", "å…¬å¼€è¯¾", "è¯¾ç¨‹", "æ•™ç¨‹", "è€ƒç ”",
            "é›…æ€", "æ‰˜ç¦", "è¯»ä¹¦", "çŸ¥ä¹", "æœŸåˆŠ", "æ‚å¿—",
            "è€ƒå…¬", "ç½‘è¯¾", "åšå®¢", "blog", "å°‘æ•°æ´¾",
            "å€¼å¾—è¯»", "è±†ç“£", "ç»æµå­¦", "å“²å­¦",
            "ç»´åŸºç™¾ç§‘", "wikipedia", "æœ‰å£°", "å†™ä½œ",
        ]
    },
    {
        "name": "ğŸ“¡ ç¤¾åª’æ¬è¿",
        "keywords": [
            "æ¨ç‰¹", "twitter", "å¾®åš", "reddit", "é¥­å¦",
            "å¾®ä¿¡æ¬è¿", "ç²¾é€‰", "ç¿»è¯‘æ¨", "å…¬ä¼—å·",
        ]
    },
    {
        "name": "ğŸ¨ åˆ›æ„è®¾è®¡",
        "keywords": [
            "è®¾è®¡", "design", "ui", "ux", "æ’ç‰ˆ",
            "å­—ä½“", "ç”»å®¤", "ç¾æœ¯", "è‰ºæœ¯", "art",
            "åˆ›æ„", "å“ç‰Œ",
        ]
    },
    {
        "name": "ğŸ€ ä½“è‚²è¿åŠ¨",
        "keywords": [
            "ä½“è‚²", "è¶³çƒ", "ç¯®çƒ", "nba", "cba",
            "è¿åŠ¨", "å¥èº«", "è·‘æ­¥", "ä¸–ç•Œæ¯", "æ¬§å† ",
        ]
    },
    {
        "name": "ğŸ‘— ç”Ÿæ´»æ¶ˆè´¹",
        "keywords": [
            "æ—¥å¸¸", "è´­ç‰©", "è–…ç¾Šæ¯›", "ç¾Šæ¯›", "ä¼˜æƒ ", "æŠ˜æ‰£",
            "æ·˜å®", "äº¬ä¸œ", "æ‹¼å¤šå¤š", "å¤–å–", "æ±‚èŒ", "æ‹›è˜",
            "èŒåœº", "æ—…æ¸¸", "æœºç¥¨", "ç¾é£Ÿ", "å£çº¸", "wallpaper",
            "å¤´åƒ", "æ–‡æ¡ˆ", "æ‘„å½±", "é¢œå€¼", "ç¾å›¾",
            "ä¿¡ç”¨å¡", "simå¡", "æ¡æ¼", "é™å…", "äºšé©¬é€Š", "amazon",
            "åœ°éœ‡", "å¤©æ°”",
        ]
    },
    {
        "name": "ğŸŒ åœ°åŒºç¤¾ç¾¤",
        "keywords": [
            "æ¹–å—", "å¹¿è¥¿", "å››å·", "è¥¿å®‰", "æµå—", "å‘¨å£",
            "æ²³å—", "åŒ—äº¬", "ä¸Šæµ·", "å¹¿ä¸œ", "æ·±åœ³", "æˆéƒ½",
            "å°æ¹¾", "é¦™æ¸¯", "é«˜é›„", "å¤§å­¦è”ç›Ÿ", "å¤§å­¦",
        ]
    },
    {
        "name": "ğŸ’¬ é—²èŠäº¤å‹",
        "keywords": [
            "äº¤å‹", "ç›¸äº²", "é—²èŠ", "æ°´ç¾¤", "å¹æ°´",
            "å•èº«", "èŠå¤©", "äº¤é™…", "äº’åŠ©", "åŒå¥½", "è´´å§",
            "æ²™é›•", "è¡¨æƒ…åŒ…", "è´´çº¸", "sticker", "å†·çŸ¥è¯†",
            "è¶£äº‹", "æ®µå­", "ç¬‘è¯", "çŒ«", "æ ‘æ´", "ç”µæŠ¥ç¾¤",
            "ç¢ç¢å¿µ", "æ—¥è®°", "æ‹¾è¶£", "æ€ªè¯", "æƒ…è¯",
            "v2ex",
        ]
    },
    {
        "name": "ğŸ—‚ï¸ ç»¼åˆå¯¼èˆª",
        "keywords": [
            "å¯¼èˆª", "æœç¾¤", "ç´¢å¼•", "é¢‘é“å¤§å…¨", "ç¾¤ç»„å¤§å…¨",
            "æœºå™¨äººå¤§å…¨", "å¤§å…¨", "telegram ä¸­æ–‡", "ç”µæŠ¥ä¸­æ–‡",
            "æ–°æ‰‹", "å…¥é—¨", "æŒ‡å—", "è¯­è¨€åŒ…", "ä¸­æ–‡åŒ…",
        ]
    },
    {
        # ğŸ” æ”¾åœ¨æœ€åï¼Œé¿å…ç¾¤è§„å£°æ˜ä¸­çš„å…³é”®è¯ä¼˜å…ˆåŒ¹é…åˆ°æ­¤ç±»
        "name": "ğŸ” ç¦åˆ©åƒç“œ",
        "keywords": [
            "nsfw", "è€å¸æœº", "å†™çœŸ", "å¥—å›¾", "è‰²å›¾", "æ¶©å›¾",
            "é»‘æ–™", "æ¢èŠ±", "æµ·è§’", "ç»…å£«", "å¦¹å­å›¾",
            "åƒç“œ",
        ]
    },
]


def determine_category(title: str, desc: str) -> str:
    """æ ¹æ®å…³é”®è¯æ¨æ–­åˆ†ç±»ï¼Œå¸¦ä¸Šä¸‹æ–‡æ„ŸçŸ¥ã€‚
    
    1. å…ˆç”¨ title å•ç‹¬åŒ¹é…ï¼ˆtitle ä¸­å‡ºç°çš„å…³é”®è¯æ›´å¯ä¿¡ï¼‰
    2. å†ç”¨ title + desc è”åˆåŒ¹é…
    3. è”åˆåŒ¹é…æ—¶å…ˆå‰”é™¤ç¾¤è§„å£°æ˜ä¸­çš„å…³é”®è¯ä¸Šä¸‹æ–‡
    """
    title_lower = title.lower()
    
    # ç¬¬ä¸€è½®ï¼šä»…åŒ¹é… titleï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰
    for cat in CATEGORIES:
        for kw in cat["keywords"]:
            if kw.lower() in title_lower:
                return cat["name"]
    
    # ç¬¬äºŒè½®ï¼šåŒ¹é… title + descï¼ˆå…ˆå‰”é™¤ç¾¤è§„å£°æ˜ä¸Šä¸‹æ–‡ï¼‰
    full_text = f"{title} {desc}".lower()
    full_text_cleaned = _remove_rule_context(full_text)
    
    for cat in CATEGORIES:
        for kw in cat["keywords"]:
            if kw.lower() in full_text_cleaned:
                return cat["name"]
    
    return "ğŸŒ ç»¼åˆå…¶ä»–"


def main():
    print("ğŸ§¹ å¼€å§‹æ‰§è¡Œé«˜çº§æ¸…æ´—ä¸ç²¾ç»†åˆ†ç±» (22å¤§ç±»)...")
    conn = sqlite3.connect(str(DB_PATH))
    conn.row_factory = sqlite3.Row
    
    rows = conn.execute("SELECT * FROM entries WHERE keep=1").fetchall()
    print(f"å¤„ç†ä¿ç•™çš„ {len(rows)} æ¡è®°å½•...")
    
    changed = 0
    filtered_harmful = 0
    filtered_lang = 0
    cat_counts = {}
    
    for row in rows:
        entry = dict(row)
        title = entry.get("title") or ""
        desc = entry.get("description") or ""
        full_text = title + " " + desc
        
        # 0. æœ‰å®³å†…å®¹åŠè¯­è¨€è¿‡æ»¤
        if is_harmful(full_text):
            conn.execute("UPDATE entries SET keep=0, filter_reason='æœ‰å®³å†…å®¹', updated_at=datetime('now') WHERE id=?", (entry["id"],))
            changed += 1
            filtered_harmful += 1
            print(f"  âŒ è¿‡æ»¤ (æœ‰å®³å†…å®¹): {title}")
            continue
            
        if is_non_simplified_chinese(full_text):
            conn.execute("UPDATE entries SET keep=0, filter_reason='éç®€ä¸­å†…å®¹', updated_at=datetime('now') WHERE id=?", (entry["id"],))
            changed += 1
            filtered_lang += 1
            print(f"  âŒ è¿‡æ»¤ (éç®€ä¸­å†…å®¹): {title}")
            continue

        # 1. & 2. æ¸…æ´—ä¸åˆ†ç±»
        c_title = clean_title_advanced(title) or title  # fallback
        c_desc = clean_text_advanced(desc, title)
        
        # fallback for completely wiped descriptions
        if not c_desc:
            c_desc = "æš‚æ— è¯¦ç»†ç®€ä»‹ã€‚"
            
        category = determine_category(title, desc)
        
        conn.execute(
            "UPDATE entries SET clean_title=?, clean_desc=?, category=?, updated_at=datetime('now') WHERE id=?",
            (c_title, c_desc, category, entry["id"])
        )
        changed += 1
        cat_counts[category] = cat_counts.get(category, 0) + 1
        
    conn.commit()
    conn.close()
    
    print(f"âœ… å¤„ç†å®Œæˆï¼Œå…±é‡æ–°åˆ†ç±»å’Œæ¸…æ´— {changed} æ¡è®°å½•ï¼")
    if filtered_harmful > 0 or filtered_lang > 0:
        print(f"   å…¶ä¸­æ’é™¤äº† {filtered_harmful} æ¡æœ‰å®³å†…å®¹ï¼Œ{filtered_lang} æ¡éç®€ä¸­å†…å®¹ã€‚")
    print("\nğŸ“Š åˆ†ç±»ç»Ÿè®¡ (ç•™å­˜é¡¹ç›®):")
    for cat, count in sorted(cat_counts.items(), key=lambda x: x[1], reverse=True):
        print(f"  {cat}: {count} æ¡")


if __name__ == "__main__":
    main()
