---
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';
import fs from 'fs';
import path from 'path';

// Dynamically read data to avoid Astro static import caching during Vercel builds
const dataPath = path.resolve(process.cwd(), 'public/data.json');
const data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));

// Process categories for sidebar
const categories = data.categories;

// Prepare category groups for content mapping
const categoryGroups = {};
categories.forEach(c => {
    categoryGroups[c.id] = { meta: c, items: [] };
});

data.types.forEach(typeObj => {
    typeObj.categories.forEach(catObj => {
        const catMeta = categories.find(c => c.fullName === catObj.fullName);
        if (catMeta) {
            categoryGroups[catMeta.id].items.push(...catObj.items.map(item => ({ ...item, typeName: typeObj.name })));
        }
    });
});

let totalItems = 0;
const validSections = [];

// Compute total items and sort them
Object.values(categoryGroups).forEach(group => {
    if (group.items.length === 0) return;
    
    // Sort items by count (highest first)
    group.items.sort((a, b) => {
        const countA = a.countStr ? parseInt(a.countStr.replace(/,/g, '')) : 0;
        const countB = b.countStr ? parseInt(b.countStr.replace(/,/g, '')) : 0;
        return countB - countA;
    });

    totalItems += group.items.length;
    validSections.push(group);
});

// Pick 6 random items for Daily Picks (Featured)
const allItems = validSections.flatMap(g => g.items);
// Deterministic pseudo-random shuffle to lock the "daily" picks per build
const featuredItems = [...allItems].sort(() => Math.random() - 0.5).slice(0, 6);
---

<Layout>
  <div id="app">
    <!-- 侧边栏 -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2" fill="none"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
          <div class="sidebar-title">rectg 导航</div>
        </div>
        <button id="close-sidebar-btn" aria-label="关闭侧边栏">
          <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav id="category-nav">
        <!-- 每日精选 -->
        <div class="nav-item active" data-id="featured">
            <span class="nav-icon">🔥</span>
            <span>每日精选</span>
        </div>
        <!-- JS 注入改为了直接服务端渲染 -->
        {categories.map(cat => (
          <div class="nav-item" data-id={cat.id}>
              <span class="nav-icon">{cat.icon}</span>
              <span>{cat.name}</span>
          </div>
        ))}
      </nav>
      <div class="sidebar-footer">
        <a href="https://github.com/jackhawks/rectg/issues/new" target="_blank" rel="noopener" class="submit-btn" title="提交新的频道或群组">
          ✨ 提交收录
        </a>
      </div>
    </aside>

    <!-- 移动端侧边栏遮罩 -->
    <div id="sidebar-overlay"></div>

    <!-- 主内容区 -->
    <main>
      <header>
        <div class="header-left">
          <button id="menu-btn" aria-label="菜单">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <!-- 移动端显示的标题 -->
          <h2 class="mobile-title">rectg 导航</h2>
        </div>

        <div class="header-right">
          <div class="search-box">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" placeholder="搜索资源、全能搜..." />
          </div>
          <button id="theme-toggle" aria-label="切换主题">
            <svg class="moon-icon" viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <svg class="sun-icon" viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
        </div>
      </header>

      <!-- Reading Progress Bar -->
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>

      <div class="hero">
        <h1 class="hero-title">rectg – Telegram 精选导航</h1>
        <p class="hero-subtitle">1000+ 优质中文频道与群组推荐，持续更新</p>
        <div class="hero-badges">
          <span class="hero-badge">已收录 {totalItems}+ 高质量资源</span>
          <span class="hero-badge">覆盖 {validSections.length} 个分类</span>
        </div>
      </div>

      <div class="bulletin" id="bulletin">
        <span class="bulletin-icon">📢</span>
        <div class="bulletin-text-container">
          <span id="bulletin-text">本站数据基于 GitHub README 自动构建部署，已收录 {totalItems}+ 高质量内容。</span>
        </div>
      </div>

      <!-- 内容区卡片列表 -->
      <div id="content-container">
         <!-- 每日精选 -->
         <div class="category-section" id="cat-featured">
             <h3 class="category-title">
                 🔥 每日精选
                 <span class="category-title-meta">(随机推荐)</span>
             </h3>
             <div class="grid">
                 {featuredItems.map(item => (
                     <Card 
                         id={item.id}
                         title={item.title}
                         desc={item.desc}
                         url={item.url}
                         typeName={item.typeName}
                         countStr={item.countStr}
                         category="🔥 每日精选"
                     />
                 ))}
             </div>
         </div>

         {validSections.map(group => (
            <div class="category-section" id={`cat-${group.meta.id}`}>
                <h3 class="category-title">
                    {group.meta.fullName}
                    <span class="category-title-meta">({group.items.length})</span>
                </h3>
                <div class="grid">
                    {group.items.map(item => (
                        <Card 
                            id={item.id}
                            title={item.title}
                            desc={item.desc}
                            url={item.url}
                            typeName={item.typeName}
                            countStr={item.countStr}
                            category={`${group.meta.fullName} ${group.meta.keywords || ''}`}
                        />
                    ))}
                </div>
            </div>
         ))}
         
         <!-- 空状态 -->
         <div id="empty-state" class="empty-state" style="display: none;">
            <h3>未找到匹配的结果</h3>
            <p>尝试搜索其他关键词</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Back to Top Button -->
  <button id="back-to-top" class="back-to-top" aria-label="返回顶部">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="19" x2="12" y2="5"></line>
      <polyline points="5 12 12 5 19 12"></polyline>
    </svg>
  </button>
  
  <div id="toast" class="toast">已复制链接</div>

  <footer class="site-footer">
    <div class="footer-content">
      <p>⚠️ <strong>免责声明</strong>：本网站仅供技术学习与信息导航使用。严禁中国大陆地区用户使用，所有使用者须严格遵守所在地区法律法规，一切因违规使用产生的法律责任均与本网站无关。</p>
      <p class="footer-copyright">© 2026 rectg – Telegram 精选导航</p>
    </div>
  </footer>

  <script src="../scripts/main.js"></script>
</Layout>
